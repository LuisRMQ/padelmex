<div *ngIf="warningMsg" class="warning">
  {{ warningMsg }}
</div>

<div *ngIf="error" class="error">
  {{ error }}
</div>

<div class="header">
  <h2>Reservaciones del {{ selectedDate | date: 'longDate' }}</h2>
  <div class="quick-buttons">
    <button mat-raised-button style="border-radius: 15px;" color="primary" class="btn-header"
      (click)="setToYesterday()">Ayer</button>
    <button mat-raised-button style="border-radius: 15px;" color="primary" class="btn-header"
      (click)="setToToday()">Hoy</button>
    <button mat-raised-button style="border-radius: 15px;" color="primary" class="btn-header"
      (click)="setToTomorrow()">Mañana</button>
  </div>
</div>

<mat-divider class="divider"></mat-divider>

<div class="selectors">
  <div class="date-selector">
    <mat-form-field appearance="outline" style="width: 200px;">
      <mat-label>Selecciona una Fecha</mat-label>
      <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" (dateChange)="onDateChange($event.value)">
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 300px;">
      <mat-label>Seleccionar Club</mat-label>
      <mat-select [(value)]="selectedClubId" (selectionChange)="onClubChange()">
        <mat-option *ngFor="let club of clubs" [value]="club.id">
          {{ club.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <h6>
    <span *ngIf="selectedCourtId === null || selectedCourtId === undefined">
      Ocupación: {{ getTotalOccupationHours() }} horas
      ({{ getOccupationPercentage() }}%, {{ getTotalClients() }} Clientes) |
      Media: {{ getAverageOccupation() }}
    </span>
    <span *ngIf="selectedCourtId !== null && selectedCourtId !== undefined">
      Cancha {{ getCourtName(selectedCourtId) }}:
      {{ getCourtOccupationHours(selectedCourtId) }} horas
      ({{ getCourtOccupationPercentage(selectedCourtId) }}%,
      {{ getCourtClients(selectedCourtId) }} Clientes)
    </span>
  </h6>
</div>

<!-- Estados de carga -->
<div *ngIf="loading" class="loading-state">
  <mat-spinner diameter="40"></mat-spinner>
  <span>Cargando clubs...</span>
</div>

<div *ngIf="loadingReservations" class="loading-state">
  <mat-spinner diameter="40"></mat-spinner>
  <span>Cargando reservaciones...</span>
</div>

<div *ngIf="!loading && clubs.length === 0" class="empty-state">
  <mat-icon>sports_tennis</mat-icon>
  <p>No hay clubs disponibles</p>
</div>

<div *ngIf="!loading && clubs.length > 0 && courts.length === 0 && !loadingReservations" class="empty-state">
  <mat-icon>question_mark</mat-icon>
  <p>No hay canchas disponibles para este club</p>
</div>

<!-- Calendario principal -->
<div class="board" *ngIf="!loading && !loadingReservations && courts.length > 0">
  <!-- Columna de horas -->
  <div class="time-gutter">
    <div class="gutter-header"></div>
    <div class="time-label" *ngFor="let t of times" [style.top.px]="minutesToPx(t.min - dayStartMin)">
      {{ t.label }}
    </div>
  </div>

  <div class="board-scroll" #boardScrollRef [style.height.px]="(dayEndMin - dayStartMin) * pxPerMin + 60">
    <div class="columns">
      <div class="court-col" *ngFor="let court of courts; let i = index" #courtColRef
        [class.past-court-col]="isCourtColPast()">

        <div class="court-header">
          {{ court.name }}
          <span *ngIf="getCourtReservationCount(court.id) > 0" class="reservation-count">
            ({{ getCourtReservationCount(court.id) }})
          </span>
        </div>

        <div class="time-grid" [style.height.px]="(dayEndMin - dayStartMin) * pxPerMin">
          <div class="time-slot" *ngFor="let t of times; let ti = index"
            [style.top.px]="minutesToPx(t.min - dayStartMin)" [class.past-slot]="isPastSlot(t.min)"
            [class.slot-selectable]="!isPastSlot(t.min) && !isSlotReserved(court.id, t.min)"
            (click)="handleSlotClick($event, court, t.min)">
          </div>
        </div>

        <div class="reservations-layer">
          <div class="reservation" *ngFor="let res of reservations" [class.hidden]="res.courtId !== court.id"
            [ngStyle]="getReservationStyle(res)" cdkDrag
            (cdkDragStarted)="onDragStarted($event, res, $event.source.element.nativeElement)"
            (cdkDragEnded)="onDragEnded($event, res, $event.source.element.nativeElement)"
            (mouseenter)="showReservationDetails($event, res)" (mouseleave)="hideReservationDetails()">

            <div class="res-title">
              {{ res.user }} • {{ formatTime(res.startMin) }}–{{ formatTime(res.endMin) }}
            </div>

            <!-- Usando métodos del componente -->
            <div *ngIf="res.originalData?.status" class="res-status" [ngClass]="getStatusClass(res)">
              {{ getStatusText(res) }}
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TEMPLATE DEL TOOLTIP (FUERA de cualquier otro div) -->
<ng-template #reservationTooltip>
  <div class="reservation-details-tooltip" [style.left.px]="tooltipPosition.x" [style.top.px]="tooltipPosition.y">
    <div *ngIf="isLoadingDetails" class="loading-details">
      <mat-spinner diameter="20"></mat-spinner>
      <span>Cargando detalles...</span>
    </div>

    <div *ngIf="!isLoadingDetails && currentReservation?.details" class="details-content">
      <!-- Header -->
      <div class="tooltip-header">
        <h4>Detalles de la Reservación #{{ currentReservation?.details?.id }}</h4>
        <span class="status-badge" [style.background-color]="getStatusColor(currentReservation?.details?.status)">
          {{ currentReservation?.details?.status | titlecase }}
        </span>
      </div>

      <!-- Información principal -->
      <div class="detail-section">
        <div class="detail-row">
          <mat-icon>person</mat-icon>
          <span><strong>Usuario ID:</strong> {{ currentReservation?.details?.user_id }}</span>
        </div>
        <div class="detail-row">
          <mat-icon>sports_tennis</mat-icon>
          <span><strong>Cancha ID:</strong> {{ currentReservation?.details?.court_id }}</span>
        </div>
        <div class="detail-row">
          <mat-icon>calendar_today</mat-icon>
          <span><strong>Fecha:</strong> {{ formatDateString(currentReservation?.details?.date) }}</span>
        </div>
        <div class="detail-row">
          <mat-icon>schedule</mat-icon>
          <span><strong>Horario:</strong> {{ currentReservation?.details?.start_time | slice:0:5 }} - {{
            currentReservation?.details?.end_time | slice:0:5 }}</span>
        </div>
        <div class="detail-row">
          <mat-icon>timer</mat-icon>
          <span><strong>Duración:</strong> {{ currentReservation?.details?.duration }} minutos</span>
        </div>
      </div>

      <!-- Información de pago -->
      <div class="detail-section">
        <div class="detail-row">
          <mat-icon>payment</mat-icon>
          <span><strong>Método pago:</strong> {{ currentReservation?.details?.pay_method | titlecase }}</span>
        </div>
        <div class="detail-row">
          <mat-icon>attach_money</mat-icon>
          <span><strong>Total Cancha:</strong> {{ formatCurrency(currentReservation?.details?.total_court) }}</span>
        </div>
        <div class="detail-row">
          <mat-icon>percent</mat-icon>
          <span><strong>Comisión:</strong> {{ formatCurrency(currentReservation?.details?.commission) }}</span>
        </div>
        <div class="detail-row total-row">
          <mat-icon>point_of_sale</mat-icon>
          <span><strong>Total:</strong> {{ formatCurrency(currentReservation?.details?.total) }}</span>
        </div>
      </div>

      <!-- Información adicional -->
      <div class="detail-section" *ngIf="currentReservation?.details?.observations">
        <div class="detail-row">
          <mat-icon>notes</mat-icon>
          <span><strong>Observaciones:</strong> {{ currentReservation?.details?.observations }}</span>
        </div>
      </div>

      <!-- Fechas del sistema -->
      <div class="detail-section dates-section">
        <div class="detail-row">
          <mat-icon>event</mat-icon>
          <span><strong>Creado:</strong> {{ formatDateString(currentReservation?.details?.created_at) }}</span>
        </div>
        <div class="detail-row">
          <mat-icon>update</mat-icon>
          <span><strong>Actualizado:</strong> {{ formatDateString(currentReservation?.details?.updated_at) }}</span>
        </div>
      </div>

      <!-- Botones de acción -->
      <!-- <div class="action-buttons">
        <button mat-button color="primary" (click)="editReservation(currentReservation!)">
          <mat-icon>edit</mat-icon>
          Editar
        </button>
        <button mat-button color="warn" (click)="cancelReservation(currentReservation!)" 
                *ngIf="currentReservation?.details?.status !== 'cancelled' && currentReservation?.details?.status !== 'deleted'">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
      </div> -->
    </div>

    <div *ngIf="!isLoadingDetails && !currentReservation?.details" class="error-message">
      No se pudieron cargar los detalles de la reservación.
    </div>
  </div>
</ng-template>

<!-- OVERLAY DEL TOOLTIP (FUERA del template, al final del archivo) -->
<div *ngIf="currentReservation" class="tooltip-overlay" (mouseleave)="hideReservationDetails()">
  <ng-container *ngTemplateOutlet="reservationTooltip"></ng-container>
</div>