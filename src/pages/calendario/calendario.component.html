<div *ngIf="warningMsg" class="warning">
  {{ warningMsg }}
</div>

<div *ngIf="error" class="error">
  {{ error }}
</div>

<div class="header">
  <h2>Reservaciones del {{ selectedDate | date: 'longDate' }}</h2>
  <div class="quick-buttons">
    <button mat-raised-button style="border-radius: 15px;" color="primary" class="btn-header"
      (click)="setToYesterday()">Ayer</button>
    <button mat-raised-button style="border-radius: 15px;" color="primary" class="btn-header"
      (click)="setToToday()">Hoy</button>
    <button mat-raised-button style="border-radius: 15px;" color="primary" class="btn-header"
      (click)="setToTomorrow()">Mañana</button>
      <mat-icon color="primary" style="font-size: 28px; cursor: pointer;" (click)="openSettingsDialog()">
      settings
    </mat-icon>
  </div>
</div>

<mat-divider class="divider"></mat-divider>

<div class="selectors">
  <div class="date-selector">
    <mat-form-field appearance="outline" style="width: 200px;">
      <mat-label>Selecciona una Fecha</mat-label>
      <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" (dateChange)="onDateChange($event.value)">
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 300px;">
      <mat-label>Seleccionar Club</mat-label>
      <mat-select [(value)]="selectedClubId" (selectionChange)="onClubChange()">
        <mat-option *ngFor="let club of clubs" [value]="club.id">
          {{ club.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <h6>
    <span *ngIf="selectedCourtId === null || selectedCourtId === undefined">
      Ocupación: {{ getTotalOccupationHours() }} horas
      ({{ getOccupationPercentage() }}%, {{ getTotalClients() }} Clientes) |
      Media: {{ getAverageOccupation() }}
    </span>
    <span *ngIf="selectedCourtId !== null && selectedCourtId !== undefined">
      Cancha {{ getCourtName(selectedCourtId) }}:
      {{ getCourtOccupationHours(selectedCourtId) }} horas
      ({{ getCourtOccupationPercentage(selectedCourtId) }}%,
      {{ getCourtClients(selectedCourtId) }} Clientes)
    </span>
  </h6>
</div>

<!-- Estados de carga -->
<div *ngIf="loading" class="loading-state">
  <mat-spinner diameter="40"></mat-spinner>
  <span>Cargando clubs...</span>
</div>

<div *ngIf="loadingReservations" class="loading-state">
  <mat-spinner diameter="40"></mat-spinner>
  <span>Cargando reservaciones...</span>
</div>

<div *ngIf="!loading && clubs.length === 0" class="empty-state">
  <mat-icon>sports_tennis</mat-icon>
  <p>No hay clubs disponibles</p>
</div>

<div *ngIf="!loading && clubs.length > 0 && courts.length === 0 && !loadingReservations" class="empty-state">
  <mat-icon>question_mark</mat-icon>
  <p>No hay canchas disponibles para este club</p>
</div>

<!-- Calendario principal -->
<div class="board" *ngIf="!loading && !loadingReservations && courts.length > 0">
  <!-- Columna de horas -->
  <div class="time-gutter">
    <div class="gutter-header"></div>
    <div class="time-label" *ngFor="let t of times" [style.top.px]="minutesToPx(t.min - dayStartMin)">
      {{ t.label }}
    </div>
  </div>

  <div class="board-scroll" #boardScrollRef [style.height.px]="(dayEndMin - dayStartMin) * pxPerMin + 60">
    <div class="columns">
      <div class="court-col" *ngFor="let court of courts; let i = index" #courtColRef
        [class.past-court-col]="isCourtColPast()">

        <div class="court-header">
          {{ court.name }}
          <span *ngIf="getCourtReservationCount(court.id) > 0" class="reservation-count">
            ({{ getCourtReservationCount(court.id) }})
          </span>
        </div>

        <div class="time-grid" [style.height.px]="(dayEndMin - dayStartMin) * pxPerMin">
          <div class="time-slot" *ngFor="let t of times; let ti = index"
            [style.top.px]="minutesToPx(t.min - dayStartMin)" [class.past-slot]="isPastSlot(t.min)"
            [class.slot-selectable]="!isPastSlot(t.min) && !isSlotReserved(court.id, t.min)"
            (click)="handleSlotClick($event, court, t.min)">
          </div>
        </div>

        <div class="reservations-layer">
          <div class="reservation" *ngFor="let res of reservations" [class.hidden]="res.courtId !== court.id"
            [ngStyle]="getReservationStyle(res)" cdkDrag
            (cdkDragStarted)="onDragStarted($event, res, $event.source.element.nativeElement)"
            (cdkDragEnded)="onDragEnded($event, res, $event.source.element.nativeElement)"
            (click)="onReservationClick(res)">

            <div class="res-title">
              {{ res.user }} • {{ formatTime(res.startMin) }}–{{ formatTime(res.endMin) }}
            </div>

            <!-- Usando métodos del componente -->
            <div *ngIf="res.originalData?.status" class="res-status" [ngClass]="getStatusClass(res)">
              {{ getStatusText(res) }}
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>