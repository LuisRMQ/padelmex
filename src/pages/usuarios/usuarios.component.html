<div *ngIf="!selectedUsuario">

  <!-- LOADER -->
  <div *ngIf="loading" class="loading-overlay">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Cargando usuarios...</p>
  </div>

  <!-- Encabezado -->
  <div class="header">
    <h2>Usuarios</h2>
    <button mat-raised-button color="accent" class="btn-agregar" (click)="abrirModalRegistrarUsuario()">
      <mat-icon>add</mat-icon> AGREGAR USUARIO
    </button>
  </div>
  <div class="usuarios-container">

    <!-- Filtros -->
    <div class="usuarios-filtros">
      <input class="usuarios-search" type="text" placeholder="Buscar usuarios..." (keyup)="applyFilter($event)">

      <!-- FILTROS AVANZADOS -->
      <div class="filtros-advanced">

        <!-- Género -->
        <mat-form-field appearance="outline">
          <mat-label>Género</mat-label>
          <mat-select [(ngModel)]="filtros.gender" (selectionChange)="aplicarFiltros()">
            <mat-option value="">Todos</mat-option>
            <mat-option value="male">Hombre</mat-option>
            <mat-option value="female">Mujer</mat-option>
          </mat-select>
        </mat-form-field>



        <!-- Club -->
        <mat-form-field appearance="outline">
          <mat-label>Club</mat-label>
          <mat-select [(ngModel)]="filtros.club_id" (selectionChange)="aplicarFiltros()">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let club of clubs" [value]="club.id">
              {{ club.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select [(ngModel)]="estadoSeleccionado" (selectionChange)="onEstadoChange()">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let estado of estados" [value]="estado">
              {{ estado }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- CIUDAD -->
        <mat-form-field appearance="outline">
          <mat-label>Ciudad</mat-label>
          <mat-select [(ngModel)]="filtros.city" (selectionChange)="aplicarFiltros()">
            <mat-option value="">Todas</mat-option>
            <mat-option *ngFor="let ciudad of ciudadesFiltradas" [value]="ciudad">
              {{ ciudad }}
            </mat-option>
          </mat-select>
        </mat-form-field>



        <!-- Nivel -->
        <mat-form-field appearance="outline">
          <mat-label>Nivel</mat-label>
          <mat-select [(ngModel)]="filtros.level" (selectionChange)="aplicarFiltros()">
            <mat-option value="">Todos</mat-option>
            <mat-option value="1">Nivel 1</mat-option>
            <mat-option value="2">Nivel 2</mat-option>
            <mat-option value="3">Nivel 3</mat-option>
            <mat-option value="4">Nivel 4</mat-option>
            <mat-option value="5">Nivel 5</mat-option>
            <mat-option value="6">Nivel 6</mat-option>
            <mat-option value="7">Nivel 7</mat-option>

          </mat-select>
        </mat-form-field>


        <mat-form-field appearance="fill">
          <mat-label>Ordenar por puntos</mat-label>
          <mat-select [(ngModel)]="filtros.order" (selectionChange)="aplicarFiltros()">
            <mat-option value="">Sin orden</mat-option>
            <mat-option value="asc">Menor a mayor</mat-option>
            <mat-option value="desc">Mayor a menor</mat-option>
          </mat-select>
        </mat-form-field>

      </div>

    </div>

    <!-- Tarjetas resumen -->
    <div class="usuarios-resumen">
      <div class="resumen-card">
        <div class="resumen-icon total"><mat-icon>groups</mat-icon></div>
        <div class="resumen-label">Total Usuarios</div>
        <div class="resumen-value">{{ getTotalUsuarios() }}</div>
      </div>

      <div class="resumen-card">
        <div class="resumen-icon activos"><mat-icon>directions_run</mat-icon></div>
        <div class="resumen-label">Jugadores Activos</div>
        <div class="resumen-value">{{ getTotalUsuariosByRol('jugador') }}</div>
      </div>

      <div class="resumen-card">
        <div class="resumen-icon entrenadores"><mat-icon>emoji_events</mat-icon></div>
        <div class="resumen-label">Entrenadores</div>
        <div class="resumen-value">{{ getTotalUsuariosByRol('coach') }}</div>
      </div>

      <div class="resumen-card">
        <div class="resumen-icon victorias"><mat-icon>military_tech</mat-icon></div>
        <div class="resumen-label">Categoria con mas Usuarios</div>
        <div class="resumen-value">{{ getCategoriaConMasUsuarios() }}</div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="usuarios-lista">
      <div class="usuarios-lista-header">
        <span>Lista de Usuarios</span>
      </div>

      <table mat-table [dataSource]="dataSource" class="usuarios-table">

        <!-- NOMBRE -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>NOMBRE</th>
          <td mat-cell *matCellDef="let usuario">
            <div class="usuario-nombre">
              <img class="usuario-avatar" [src]="usuario.fotoPerfil || 'assets/img/user.png'"
                (error)="onImgError($event)" alt="avatar">
              <div>
                <div class="nombre">{{ usuario.nombre }} {{ usuario.apellidos }}</div>
                <div class="correo">{{ usuario.correo }}</div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- TELEFONO -->
        <ng-container matColumnDef="telefono">
          <th mat-header-cell *matHeaderCellDef>TELEFONO</th>
          <td mat-cell *matCellDef="let usuario">
            <span>
              {{ usuario.area_code && usuario.telefono ? (usuario.area_code + ' ' + usuario.telefono) : 'Sin Asignar' }}
            </span>
          </td>
        </ng-container>

        <!-- ROL -->
        <ng-container matColumnDef="rol">
          <th mat-header-cell *matHeaderCellDef>ROL</th>
          <td mat-cell *matCellDef="let usuario">
            <span class="badge-rol" [ngClass]="usuario.rol | lowercase">{{ usuario.rol }}</span>
          </td>
        </ng-container>

        <!-- CLUB -->
        <ng-container matColumnDef="club">
          <th mat-header-cell *matHeaderCellDef>CLUB</th>
          <td mat-cell *matCellDef="let usuario">{{ usuario.club }}</td>
        </ng-container>

        <!-- NIVEL -->
        <ng-container matColumnDef="nivel">
          <th mat-header-cell *matHeaderCellDef>NIVEL / PUNTOS</th>
          <td mat-cell *matCellDef="let usuario">{{ usuario.level }} / {{ usuario.point }}</td>
        </ng-container>

        <!-- CATEGORIA -->
        <ng-container matColumnDef="categoria">
          <th mat-header-cell *matHeaderCellDef>CATEGORÍA</th>
          <td mat-cell *matCellDef="let usuario">
            <span class="badge-categoria" [ngClass]="usuario.categoria | lowercase">
              {{ usuario.categoria }}
            </span>
          </td>
        </ng-container>

        <!-- ACCIONES -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>ACCIONES</th>
          <td mat-cell *matCellDef="let usuario">
            <button mat-icon-button color="primary" (click)="VerReservaciones(usuario)">
              <mat-icon>sports_handball</mat-icon>
            </button>

            <button mat-icon-button color="primary" (click)="abrirHistorialTorneo(usuario)">
              <mat-icon>military_tech</mat-icon>
            </button>

            <button mat-icon-button color="accent" (click)="abrirModalEditarUsuario(usuario)">
              <mat-icon>edit</mat-icon>
            </button>

            <button mat-icon-button color="warn" (click)="eliminarUsuario(usuario)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>

      <!-- PAGINADOR OFICIAL -->
      <mat-paginator [pageSize]="20" [pageSizeOptions]="[10,20,50,100]" showFirstLastButtons>
      </mat-paginator>

    </div>

  </div>

</div>